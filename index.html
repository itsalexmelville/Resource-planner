<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Design Studio Forecasting</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCY2KvEMW4hvXN6ai2kS3Wmcv-F3BMUGZQ",
          authDomain: "design-studio-forecasting.firebaseapp.com",
          databaseURL: "https://design-studio-forecasting-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "design-studio-forecasting",
          storageBucket: "design-studio-forecasting.firebasestorage.app",
          messagingSenderId: "1024840702386",
          appId: "1:1024840702386:web:71cd7b8e5df551cc8d2cab"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const { useState, useEffect } = React;

        // Simple icon components
        const Plus = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
        );

        const X = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const Users = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
        );

        const Briefcase = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m8 0V6a2 2 0 012 2v6a2 2 0 01-2 2H8a2 2 0 01-2-2V8a2 2 0 012-2V6z" />
            </svg>
        );

        const Calendar = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
        );

        const Clock = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const Settings = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        const ChevronLeft = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
            </svg>
        );

        const ChevronRight = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
            </svg>
        );

        // Modal Component
        const Modal = ({ isOpen, onClose, title, children }) => {
          if (!isOpen) return null;

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div className="flex items-center justify-between p-6 border-b">
                  <h2 className="text-xl font-semibold">{title}</h2>
                  <button
                    onClick={onClose}
                    className="p-2 hover:bg-gray-100 rounded-full"
                  >
                    <X />
                  </button>
                </div>
                <div className="p-6">
                  {children}
                </div>
              </div>
            </div>
          );
        };

        // Week Selector Component
        const WeekSelector = ({ currentWeek, currentYear, onWeekSelect }) => {
          const [showCalendar, setShowCalendar] = useState(false);
          const [viewYear, setViewYear] = useState(currentYear);

          const getWeekNumber = (date) => {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
          };

          const getWeeksInYear = (year) => {
            const weeks = [];
            const startOfYear = new Date(year, 0, 1);
            const endOfYear = new Date(year, 11, 31);
            
            let currentDate = new Date(startOfYear);
            // Find first Monday of year
            while (currentDate.getDay() !== 1) {
              currentDate.setDate(currentDate.getDate() + 1);
            }
            
            let weekNum = 1;
            while (currentDate <= endOfYear) {
              const weekStart = new Date(currentDate);
              const weekEnd = new Date(currentDate);
              weekEnd.setDate(weekEnd.getDate() + 4); // Friday
              
              weeks.push({
                number: weekNum,
                start: new Date(weekStart),
                end: new Date(weekEnd),
                key: `${year}-${weekNum}`
              });
              
              currentDate.setDate(currentDate.getDate() + 7);
              weekNum++;
            }
            return weeks;
          };

          const weeks = getWeeksInYear(viewYear);
          const currentWeekData = weeks[currentWeek] || weeks[0];

          const formatDateRange = (start, end) => {
            if (!start || !end) return "Week 1";
            return `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
          };

          return (
            <div className="relative">
              <button
                onClick={() => setShowCalendar(!showCalendar)}
                className="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                <Calendar />
                <div className="text-left">
                  <div className="font-semibold">Week {currentWeek + 1}, {currentYear}</div>
                  <div className="text-sm text-gray-600">{formatDateRange(currentWeekData?.start, currentWeekData?.end)}</div>
                </div>
              </button>

              {showCalendar && (
                <div className="absolute top-full left-0 mt-2 bg-white border border-gray-300 rounded-lg shadow-lg z-20 w-96">
                  <div className="p-4 border-b flex items-center justify-between">
                    <button
                      onClick={() => setViewYear(viewYear - 1)}
                      className="p-1 hover:bg-gray-100 rounded"
                    >
                      <ChevronLeft />
                    </button>
                    <h3 className="font-semibold">{viewYear}</h3>
                    <button
                      onClick={() => setViewYear(viewYear + 1)}
                      className="p-1 hover:bg-gray-100 rounded"
                    >
                      <ChevronRight />
                    </button>
                  </div>
                  
                  <div className="max-h-64 overflow-y-auto p-2">
                    <div className="grid grid-cols-4 gap-2">
                      {weeks.map((week, index) => (
                        <button
                          key={week.key}
                          onClick={() => {
                            onWeekSelect(index, viewYear);
                            setShowCalendar(false);
                          }}
                          className={`p-2 text-sm rounded hover:bg-blue-50 ${
                            index === currentWeek && viewYear === currentYear
                              ? 'bg-blue-600 text-white'
                              : 'text-gray-700'
                          }`}
                        >
                          <div className="font-medium">W{week.number}</div>
                          <div className="text-xs">{formatDateRange(week.start, week.end)}</div>
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        const DesignStudioForecastingApp = () => {
          // Initialize state
          const [designers, setDesigners] = useState([
            { id: 1, name: 'Jazmine' },
            { id: 2, name: 'Josh' },
            { id: 3, name: 'Alex' },
            { id: 4, name: 'Darren' }
          ]);

          const [projects, setProjects] = useState([
            { id: 1, name: 'Project Alpha', color: '#3B82F6' },
            { id: 2, name: 'Project Beta', color: '#EF4444' }
          ]);

          const [currentWeek, setCurrentWeek] = useState(0);
          const [currentYear, setCurrentYear] = useState(new Date().getFullYear());
          const [allocations, setAllocations] = useState({});
          const [newDesignerName, setNewDesignerName] = useState('');
          const [newProjectName, setNewProjectName] = useState('');
          const [isLoading, setIsLoading] = useState(true);
          const [showTeamModal, setShowTeamModal] = useState(false);
          const [showProjectModal, setShowProjectModal] = useState(false);

          const DAILY_CAPACITY = 7;
          const DAYS_PER_WEEK = 5;

          // Load data from Firebase on startup
          useEffect(() => {
            const loadData = async () => {
              try {
                // Load designers
                const designersSnapshot = await database.ref('designers').once('value');
                if (designersSnapshot.exists()) {
                  setDesigners(designersSnapshot.val());
                }

                // Load projects
                const projectsSnapshot = await database.ref('projects').once('value');
                if (projectsSnapshot.exists()) {
                  setProjects(projectsSnapshot.val());
                }

                // Load allocations
                const allocationsSnapshot = await database.ref('allocations').once('value');
                if (allocationsSnapshot.exists()) {
                  setAllocations(allocationsSnapshot.val());
                }

                // Load current week and year
                const weekSnapshot = await database.ref('currentWeek').once('value');
                if (weekSnapshot.exists()) {
                  setCurrentWeek(weekSnapshot.val());
                }

                const yearSnapshot = await database.ref('currentYear').once('value');
                if (yearSnapshot.exists()) {
                  setCurrentYear(yearSnapshot.val());
                }
              } catch (error) {
                console.error('Error loading data:', error);
              } finally {
                setIsLoading(false);
              }
            };

            loadData();
          }, []);

          // Save data to Firebase
          const saveToFirebase = async (path, data) => {
            try {
              await database.ref(path).set(data);
            } catch (error) {
              console.error('Error saving to Firebase:', error);
            }
          };

          // Generate date labels for the current week
          const getWeekDates = (weekIndex, year) => {
            const dates = [];
            const startOfYear = new Date(year, 0, 1);
            
            // Find first Monday of the year
            let firstMonday = new Date(startOfYear);
            while (firstMonday.getDay() !== 1) {
              firstMonday.setDate(firstMonday.getDate() + 1);
            }
            
            // Calculate the start of the target week
            const weekStart = new Date(firstMonday);
            weekStart.setDate(firstMonday.getDate() + (weekIndex * 7));
            
            for (let i = 0; i < DAYS_PER_WEEK; i++) {
              const date = new Date(weekStart);
              date.setDate(weekStart.getDate() + i);
              dates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            }
            return dates;
          };

          // Get allocation key
          const getAllocationKey = (designerId, projectId, weekIndex, dayIndex, year) => {
            return `${designerId}-${projectId}-${year}-${weekIndex}-${dayIndex}`;
          };

          // Get allocation value
          const getAllocation = (designerId, projectId, weekIndex, dayIndex, year = currentYear) => {
            const key = getAllocationKey(designerId, projectId, weekIndex, dayIndex, year);
            return allocations[key] || 0;
          };

          // Update allocation
          const updateAllocation = (designerId, projectId, weekIndex, dayIndex, hours) => {
            const key = getAllocationKey(designerId, projectId, weekIndex, dayIndex, currentYear);
            const numHours = Math.max(0, Math.min(DAILY_CAPACITY, parseFloat(hours) || 0));
            const newAllocations = {
              ...allocations,
              [key]: numHours
            };
            setAllocations(newAllocations);
            saveToFirebase('allocations', newAllocations);
          };

          // Calculate total hours for a designer on a specific day
          const getDailyTotal = (designerId, weekIndex, dayIndex) => {
            return projects.reduce((total, project) => {
              return total + getAllocation(designerId, project.id, weekIndex, dayIndex, currentYear);
            }, 0);
          };

          // Calculate weekly totals
          const getWeeklyTotal = (designerId, weekIndex) => {
            let total = 0;
            for (let day = 0; day < DAYS_PER_WEEK; day++) {
              total += getDailyTotal(designerId, weekIndex, day);
            }
            return total;
          };

          // Calculate project totals
          const getProjectTotal = (projectId, weekIndex) => {
            let total = 0;
            for (let day = 0; day < DAYS_PER_WEEK; day++) {
              designers.forEach(designer => {
                total += getAllocation(designer.id, projectId, weekIndex, day, currentYear);
              });
            }
            return total;
          };

          // Add designer
          const addDesigner = () => {
            if (newDesignerName.trim()) {
              const newId = Math.max(...designers.map(d => d.id), 0) + 1;
              const newDesigners = [...designers, { id: newId, name: newDesignerName.trim() }];
              setDesigners(newDesigners);
              saveToFirebase('designers', newDesigners);
              setNewDesignerName('');
            }
          };

          // Remove designer
          const removeDesigner = (id) => {
            if (designers.length > 1) {
              const newDesigners = designers.filter(d => d.id !== id);
              setDesigners(newDesigners);
              saveToFirebase('designers', newDesigners);
              
              // Clean up allocations for removed designer
              const newAllocations = { ...allocations };
              Object.keys(newAllocations).forEach(key => {
                if (key.startsWith(`${id}-`)) {
                  delete newAllocations[key];
                }
              });
              setAllocations(newAllocations);
              saveToFirebase('allocations', newAllocations);
            }
          };

          // Add project
          const addProject = () => {
            if (newProjectName.trim()) {
              const colors = ['#10B981', '#8B5CF6', '#F59E0B', '#06B6D4', '#84CC16', '#EC4899'];
              const newId = Math.max(...projects.map(p => p.id), 0) + 1;
              const color = colors[projects.length % colors.length];
              const newProjects = [...projects, { id: newId, name: newProjectName.trim(), color }];
              setProjects(newProjects);
              saveToFirebase('projects', newProjects);
              setNewProjectName('');
            }
          };

          // Remove project
          const removeProject = (id) => {
            if (projects.length > 1) {
              const newProjects = projects.filter(p => p.id !== id);
              setProjects(newProjects);
              saveToFirebase('projects', newProjects);
              
              // Clean up allocations for removed project
              const newAllocations = { ...allocations };
              Object.keys(newAllocations).forEach(key => {
                if (key.includes(`-${id}-`)) {
                  delete newAllocations[key];
                }
              });
              setAllocations(newAllocations);
              saveToFirebase('allocations', newAllocations);
            }
          };

          // Handle week selection
          const handleWeekSelect = (weekIndex, year) => {
            setCurrentWeek(weekIndex);
            setCurrentYear(year);
            saveToFirebase('currentWeek', weekIndex);
            saveToFirebase('currentYear', year);
          };

          const weekDates = getWeekDates(currentWeek, currentYear);

          // Show loading state while data loads
          if (isLoading) {
            return (
              <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <div className="text-center">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                  <p className="text-gray-600">Loading your forecast data...</p>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gray-50 p-6">
              <div className="max-w-7xl mx-auto">
                {/* Header */}
                <div className="mb-8">
                  <div className="flex items-center justify-between">
                    <div>
                      <h1 className="text-3xl font-bold text-gray-900 mb-2">Design Studio Forecasting</h1>
                      <p className="text-gray-600">Manage your team's capacity and project allocations</p>
                    </div>
                    <button
                      onClick={() => setShowTeamModal(true)}
                      className="flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                    >
                      <Settings />
                      <span>Configure</span>
                    </button>
                  </div>
                </div>

                {/* Week Navigation */}
                <div className="bg-white rounded-lg shadow-sm border p-6 mb-6">
                  <div className="flex items-center justify-between">
                    <WeekSelector 
                      currentWeek={currentWeek}
                      currentYear={currentYear}
                      onWeekSelect={handleWeekSelect}
                    />
                    
                    <div className="flex items-center space-x-4">
                      <button
                        onClick={() => handleWeekSelect(Math.max(0, currentWeek - 1), currentYear)}
                        className="px-3 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 text-sm"
                        disabled={currentWeek === 0}
                      >
                        ← Prev Week
                      </button>
                      <button
                        onClick={() => handleWeekSelect(currentWeek + 1, currentYear)}
                        className="px-3 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 text-sm"
                      >
                        Next Week →
                      </button>
                    </div>
                  </div>
                </div>

                {/* Main Forecasting Grid */}
                <div className="bg-white rounded-lg shadow-sm border overflow-hidden">
                  <div className="p-4 bg-gray-50 border-b">
                    <h2 className="text-xl font-semibold flex items-center">
                      <Clock />
                      <span className="ml-2">Week {currentWeek + 1}, {currentYear} - {weekDates[0]} to {weekDates[4]}</span>
                    </h2>
                  </div>

                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead>
                        <tr className="bg-gray-50 border-b">
                          <th className="text-left p-3 font-semibold">Designer</th>
                          {weekDates.map((date, index) => (
                            <th key={index} className="text-center p-3 font-semibold min-w-32">
                              {date}
                            </th>
                          ))}
                          <th className="text-center p-3 font-semibold">Week Total</th>
                        </tr>
                      </thead>
                      <tbody>
                        {designers.map((designer) => (
                          <React.Fragment key={designer.id}>
                            {/* Designer name row */}
                            <tr className="border-b bg-blue-50">
                              <td className="p-3 font-semibold text-blue-900" colSpan={7}>
                                {designer.name}
                              </td>
                            </tr>
                            
                            {/* Project allocation rows for this designer */}
                            {projects.map((project) => (
                              <tr key={`${designer.id}-${project.id}`} className="border-b hover:bg-gray-50">
                                <td className="p-3 pl-8 text-sm">
                                  <div className="flex items-center">
                                    <div 
                                      className="w-3 h-3 rounded-full mr-2"
                                      style={{ backgroundColor: project.color }}
                                    ></div>
                                    {project.name}
                                  </div>
                                </td>
                                
                                {/* Daily allocation inputs */}
                                {Array.from({ length: DAYS_PER_WEEK }).map((_, dayIndex) => {
                                  const currentAllocation = getAllocation(designer.id, project.id, currentWeek, dayIndex, currentYear);
                                  const dailyTotal = getDailyTotal(designer.id, currentWeek, dayIndex);
                                  const isOverCapacity = dailyTotal > DAILY_CAPACITY;
                                  
                                  return (
                                    <td key={dayIndex} className="p-2 text-center">
                                      <input
                                        type="number"
                                        min="0"
                                        max={DAILY_CAPACITY}
                                        step="0.5"
                                        value={currentAllocation || ''}
                                        onChange={(e) => updateAllocation(designer.id, project.id, currentWeek, dayIndex, e.target.value)}
                                        className={`w-16 px-2 py-1 text-center border rounded text-sm ${
                                          isOverCapacity ? 'border-red-300 bg-red-50' : 'border-gray-300'
                                        }`}
                                        placeholder="0"
                                      />
                                    </td>
                                  );
                                })}
                                
                                {/* Week total for this project */}
                                <td className="p-3 text-center text-sm font-medium">
                                  {Array.from({ length: DAYS_PER_WEEK }).reduce((total, _, dayIndex) => 
                                    total + getAllocation(designer.id, project.id, currentWeek, dayIndex, currentYear), 0
                                  ).toFixed(1)}h
                                </td>
                              </tr>
                            ))}
                            
                            {/* Daily totals row for this designer */}
                            <tr className="border-b bg-gray-100">
                              <td className="p-3 pl-8 text-sm font-semibold">Daily Totals</td>
                              {Array.from({ length: DAYS_PER_WEEK }).map((_, dayIndex) => {
                                const total = getDailyTotal(designer.id, currentWeek, dayIndex);
                                const isOverCapacity = total > DAILY_CAPACITY;
                                return (
                                  <td key={dayIndex} className={`p-3 text-center font-semibold text-sm ${
                                    isOverCapacity ? 'text-red-600' : total === DAILY_CAPACITY ? 'text-green-600' : 'text-gray-900'
                                  }`}>
                                    {total.toFixed(1)}h / {DAILY_CAPACITY}h
                                  </td>
                                );
                              })}
                              <td className="p-3 text-center font-semibold text-sm">
                                {getWeeklyTotal(designer.id, currentWeek).toFixed(1)}h / {DAILY_CAPACITY * DAYS_PER_WEEK}h
                              </td>
                            </tr>
                          </React.Fragment>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>

                {/* Project Summary */}
                <div className="mt-6 bg-white rounded-lg shadow-sm border p-6">
                  <h3 className="text-lg font-semibold mb-4">Project Summary - Week {currentWeek + 1}, {currentYear}</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {projects.map(project => {
                      const projectTotal = getProjectTotal(project.id, currentWeek);
                      return (
                        <div key={project.id} className="p-4 border rounded-lg">
                          <div className="flex items-center mb-2">
                            <div 
                              className="w-4 h-4 rounded-full mr-2"
                              style={{ backgroundColor: project.color }}
